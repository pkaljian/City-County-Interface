<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Click-to-Select (Multi + JPG Export)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/@arcgis/core/assets/esri/themes/light/main.css" />
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; }
    .panel {
      position: absolute; z-index: 5; top: 12px; left: 12px;
      background: rgba(255,255,255,.95); border-radius: 12px; padding: 12px 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12); min-width: 340px; font-family: ui-sans-serif, system-ui, Arial;
      max-height: calc(100% - 24px); overflow: auto;
    }
    .section { margin-bottom: 14px; }
    .section h3 { margin: 0 0 6px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; margin: 8px 0; }
    .row label { font-size: 13px; color: #333; }
    .muted { color: #666; font-size: 12px; }
    select, input, button {
      border: 1px solid #d0d7de; border-radius: 8px; padding: 7px 10px; font-size: 13px;
    }
    input[type="range"] { width: 170px; }
    .layer-list { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; background: #fafafa; }
    .layer-item { display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-radius:6px; }
    .layer-item:hover { background:#f0f3f6; }
    #status { font-size: 12px; color: #0b5; min-height: 1em; margin-top: 6px; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { display:inline-flex; gap:6px; align-items:center; font-size:12px; }
  </style>
</head>
<body>
  <div id="viewDiv" title="Click parcels to toggle selection"></div>

  <div class="panel">
    <div class="section">
      <h3><strong>Parcel Styling (Click to select)</strong></h3>
      <div class="muted">Click parcels to toggle them on/off. Only “Sonoma County Parcels” and “Petaluma Parcels_22_0210” are selectable.</div>
    </div>

    <div class="section">
      <h3>Layers (visibility)</h3>
      <div id="layersContainer" class="layer-list"></div>
    </div>

    <div class="section">
      <h3>Style selected parcel(s)</h3>
      <div class="row">
        <label for="colorPicker">Color</label>
        <input id="colorPicker" type="color" value="#ff5500" />
      </div>
      <div class="row">
        <label for="opacitySlider">Opacity <span id="opacityValue" class="muted">1.00</span></label>
        <input id="opacitySlider" type="range" min="0" max="1" step="0.01" value="1" />
      </div>
      <div class="btn-row">
        <button id="clearSelectionBtn">Clear selection</button>
      </div>
      <div class="muted" id="selectedInfo">No parcels selected.</div>
    </div>

    <div class="section">
      <h3>Export</h3>
      <div class="row">
        <label for="pixelRatio">Pixel ratio <span id="pxrVal" class="muted">1.0</span></label>
        <input id="pixelRatio" type="range" min="1" max="3" step="0.1" value="1" />
      </div>
      <div class="btn-row">
        <button id="exportJpgBtn">Export JPG</button>
      </div>
      <div class="muted">Higher pixel ratio = higher resolution image.</div>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import WebMap from "https://js.arcgis.com/4.29/@arcgis/core/WebMap.js";
    import MapView from "https://js.arcgis.com/4.29/@arcgis/core/views/MapView.js";
    import Color from "https://js.arcgis.com/4.29/@arcgis/core/Color.js";
    import GraphicsLayer from "https://js.arcgis.com/4.29/@arcgis/core/layers/GraphicsLayer.js";
    import Graphic from "https://js.arcgis.com/4.29/@arcgis/core/Graphic.js";

    // --- REQUIRED: your WebMap ID ---
    const WEBMAP_ID = "d2e42cb6b87c4126b2e609a362d82c1c";

    // ✅ Only these layers are selectable
    const SELECTABLE_LAYER_TITLES = [
      "Sonoma County Parcels",
      "Petaluma Parcels_22_0210"
    ];
    const selectableTitlesLower = SELECTABLE_LAYER_TITLES.map(t => t.toLowerCase());

    // Elements
    const $layersContainer = document.getElementById("layersContainer");
    const $color = document.getElementById("colorPicker");
    const $opacity = document.getElementById("opacitySlider");
    const $opacityValue = document.getElementById("opacityValue");
    const $clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const $exportJpgBtn = document.getElementById("exportJpgBtn");
    const $pixelRatio = document.getElementById("pixelRatio");
    const $pxrVal = document.getElementById("pxrVal");
    const $selectedInfo = document.getElementById("selectedInfo");
    const $status = document.getElementById("status");

    const webmap = new WebMap({ portalItem: { id: WEBMAP_ID } });
    const view = new MapView({ container: "viewDiv", map: webmap });

    // Graphics layer to draw selected parcels (non-destructive)
    const selectionOverlay = new GraphicsLayer({ title: "Selection Overlay", listMode: "hide" });
    webmap.add(selectionOverlay);

    // State
    const selectedSet = new Map(); // key -> Graphic

    function say(msg, ok = true) {
      $status.style.color = ok ? "#0b5" : "#a00";
      $status.textContent = msg;
    }

    function isSelectableLayer(layer) {
      const title = (layer.title || "").trim().toLowerCase();
      return selectableTitlesLower.includes(title);
    }

    function syncSelectedInfo() {
      const count = selectionOverlay.graphics.length;
      $selectedInfo.textContent = count ? `Selected parcels: ${count}` : "No parcels selected.";
    }

    function featureKey(layerId, objectId) { return `${layerId}|${objectId ?? crypto.randomUUID()}`; }

    function buildParcelSymbol(hex, opacity) {
      const rgba = new Color(hex); rgba.a = Number(opacity);
      return { type: "simple-fill", color: rgba, outline: { color: [0,0,0,0.35], width: 1 } };
    }

    function restyleAllSelected() {
      const color = $color.value, op = $opacity.value;
      selectionOverlay.graphics.forEach(g => { g.symbol = buildParcelSymbol(color, op); });
    }

    function toggleParcel(graphic, layerId, objectId) {
      const key = featureKey(layerId, objectId);
      if (selectedSet.has(key)) {
        // remove
        const g = selectedSet.get(key);
        selectionOverlay.remove(g);
        selectedSet.delete(key);
      } else {
        // add
        const overlayGraphic = new Graphic({
          geometry: graphic.geometry.clone(),
          symbol: buildParcelSymbol($color.value, $opacity.value),
          attributes: { layerId, objectId }
        });
        selectionOverlay.add(overlayGraphic);
        selectedSet.set(key, overlayGraphic);
      }
      syncSelectedInfo();
    }

    function buildLayerCheckbox(layer) {
      const wrapper = document.createElement("div");
      wrapper.className = "layer-item";
      const left = document.createElement("label");
      left.style.display = "flex"; left.style.alignItems = "center"; left.style.gap = "8px";

      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.checked = layer.visible;
      cb.addEventListener("change", () => { layer.visible = cb.checked; });

      const span = document.createElement("span");
      span.textContent = layer.title || layer.id;

      left.appendChild(cb); left.appendChild(span);
      wrapper.appendChild(left);
      return wrapper;
    }

    async function bootstrap() {
      await webmap.loadAll();

      // Build visibility list (all layers)
      $layersContainer.innerHTML = "";
      webmap.allLayers.forEach(layer => $layersContainer.appendChild(buildLayerCheckbox(layer)));

      // Initialize UI from first selectable layer's defaults (if present)
      const firstSelectable = webmap.allLayers.find(isSelectableLayer);
      if (firstSelectable?.renderer) {
        try {
          const sym = firstSelectable.renderer.type === "simple"
            ? firstSelectable.renderer.symbol
            : (firstSelectable.renderer.defaultSymbol || firstSelectable.renderer.uniqueValueInfos?.[0]?.symbol || firstSelectable.renderer.classBreakInfos?.[0]?.symbol);

          if (sym?.color) $color.value = new Color(sym.color).toHex();
          const op = firstSelectable.opacity ?? 1;
          $opacity.value = op; $opacityValue.textContent = Number(op).toFixed(2);
        } catch {}
      }

      say("Click parcels to toggle selection. Use color/opacity to style. Export JPG when ready.");
    }

    // Update styles live
    $color.addEventListener("input", () => { restyleAllSelected(); say("Updated color."); });
    $opacity.addEventListener("input", () => {
      const v = $opacity.value; $opacityValue.textContent = Number(v).toFixed(2);
      restyleAllSelected(); say("Updated opacity.");
    });

    $clearSelectionBtn.addEventListener("click", () => {
      selectionOverlay.removeAll();
      selectedSet.clear();
      syncSelectedInfo();
      say("Selection cleared.");
    });

    // Export JPG
    $pixelRatio.addEventListener("input", () => { $pxrVal.textContent = Number($pixelRatio.value).toFixed(1); });
    $exportJpgBtn.addEventListener("click", async () => {
      try {
        const ratio = Number($pixelRatio.value) || 1;
        const shot = await view.takeScreenshot({ format: "jpg", quality: 0.92, width: view.width * ratio, height: view.height * ratio });
        const a = document.createElement("a");
        a.href = shot.dataUrl;
        a.download = `map_export_${Date.now()}.jpg`;
        document.body.appendChild(a); a.click(); a.remove();
        say("JPG exported.");
      } catch (e) { console.error(e); say("Export failed.", false); }
    });

    // Click-to-toggle selection (topmost parcel hit from the allowed layers)
    view.on("click", async (event) => {
      const hit = await view.hitTest(event);
      if (!hit?.results?.length) { say("No feature here."); return; }

      // Find the first hit that belongs to an allowed parcel layer
      const match = hit.results.find(r => r.graphic?.layer && isSelectableLayer(r.graphic.layer));
      if (!match) { say("Clicked feature isn’t a parcel in the allowed layers.", false); return; }

      const lyr = match.graphic.layer;
      const g = match.graphic;
      const oidField = lyr.objectIdField || "OBJECTID";
      const objectId = g.attributes?.[oidField] ?? null;

      toggleParcel(g, lyr.id, objectId);
      say("Toggled parcel selection.");
    });

    view.when(bootstrap).catch(err => { console.error(err); say("Failed to load WebMap.", false); });
  </script>
</body>
</html>


