<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Click-to-Select (Multi + JPG Export)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/@arcgis/core/assets/esri/themes/light/main.css" />
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; }
    .panel {
      position: absolute; z-index: 5; top: 12px; left: 12px;
      background: rgba(255,255,255,.95); border-radius: 12px; padding: 12px 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12); min-width: 340px; font-family: ui-sans-serif, system-ui, Arial;
      max-height: calc(100% - 24px); overflow: auto;
    }
    .section { margin-bottom: 14px; }
    .section h3 { margin: 0 0 6px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; margin: 8px 0; }
    .row label { font-size: 13px; color: #333; }
    .muted { color: #666; font-size: 12px; }
    select, input, button {
      border: 1px solid #d0d7de; border-radius: 8px; padding: 7px 10px; font-size: 13px;
    }
    input[type="range"] { width: 170px; }
    .layer-list { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; background: #fafafa; }
    .layer-item { display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-radius:6px; }
    .layer-item:hover { background:#f0f3f6; }
    #status { font-size: 12px; color: #0b5; min-height: 1em; margin-top: 6px; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { display:inline-flex; gap:6px; align-items:center; font-size:12px; }
  </style>
</head>
<body>
  <div id="viewDiv" title="Click parcels to toggle selection"></div>

  <div class="panel">
    <div class="section">
      <h3><strong>Parcel Styling (Click to select)</strong></h3>
      <div class="muted">Click parcels to toggle them on/off. Only “Sonoma County Parcels” and “Petaluma Parcels_22_0210” are selectable.</div>
    </div>

    <div class="section">
      <h3>Layers (visibility)</h3>
      <div id="layersContainer" class="layer-list"></div>
    </div>

    <div class="section">
      <h3>Style selected parcel(s)</h3>
      <div class="row">
        <label for="colorPicker">Color</label>
        <input id="colorPicker" type="color" value="#ff5500" />
      </div>
      <div class="row">
        <label for="opacitySlider">Opacity <span id="opacityValue" class="muted">1.00</span></label>
        <input id="opacitySlider" type="range" min="0" max="1" step="0.01" value="1" />
      </div>
      <div class="btn-row">
        <button id="clearSelectionBtn">Clear selection</button>
      </div>
      <div class="muted" id="selectedInfo">No parcels selected.</div>
    </div>

    <div class="section">
      <h3>Export</h3>
      <div class="row">
        <label for="pixelRatio">Pixel ratio <span id="pxrVal" class="muted">1.0</span></label>
        <input id="pixelRatio" type="range" min="1" max="3" step="0.1" value="1" />
      </div>
      <div class="btn-row">
        <button id="exportJpgBtn">Export JPG</button>
      </div>
      <div class="muted">Higher pixel ratio = higher resolution image.</div>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import WebMap from "https://js.arcgis.com/4.29/@arcgis/core/WebMap.js";
    import MapView from "https://js.arcgis.com/4.29/@arcgis/core/views/MapView.js";
    import Color from "https://js.arcgis.com/4.29/@arcgis/core/Color.js";
    import GraphicsLayer from "https://js.arcgis.com/4.29/@arcgis/core/layers/GraphicsLayer.js";
    import Graphic from "https://js.arcgis.com/4.29/@arcgis/core/Graphic.js";
    import Search from "https://js.arcgis.com/4.29/@arcgis/core/widgets/Search.js";
    import FeatureLayer from "https://js.arcgis.com/4.29/@arcgis/core/layers/FeatureLayer.js";

    // --- REQUIRED: your WebMap ID ---
    const WEBMAP_ID = "d2e42cb6b87c4126b2e609a362d82c1c";

    // ✅ Only these layers are selectable
    const SELECTABLE_LAYER_TITLES = [
      "Sonoma County Parcels",
      "Petaluma Parcels_22_0210"
    ];
    const selectableTitlesLower = SELECTABLE_LAYER_TITLES.map(t => t.toLowerCase());

    // Elements
    const $layersContainer = document.getElementById("layersContainer");
    const $color = document.getElementById("colorPicker");
    const $opacity = document.getElementById("opacitySlider");
    const $opacityValue = document.getElementById("opacityValue");
    const $clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const $exportJpgBtn = document.getElementById("exportJpgBtn");
    const $pixelRatio = document.getElementById("pixelRatio");
    const $pxrVal = document.getElementById("pxrVal");
    const $selectedInfo = document.getElementById("selectedInfo");
    const $status = document.getElementById("status");

    const webmap = new WebMap({ portalItem: { id: WEBMAP_ID } });
    const view = new MapView({ container: "viewDiv", map: webmap });

    // Graphics layer to draw selected parcels (non-destructive)
    const selectionOverlay = new GraphicsLayer({ title: "Selection Overlay", listMode: "hide" });
    webmap.add(selectionOverlay);

    // State
    const selectedSet = new Map(); // key -> Graphic

    function say(msg, ok = true) {
      $status.style.color = ok ? "#0b5" : "#a00";
      $status.textContent = msg;
    }

    function isSelectableLayer(layer) {
      const title = (layer.title || "").trim().toLowerCase();
      return selectableTitlesLower.includes(title);
    }

    function syncSelectedInfo() {
      const count = selectionOverlay.graphics.length;
      $selectedInfo.textContent = count ? `Selected parcels: ${count}` : "No parcels selected.";
    }

    function featureKey(layerId, objectId) { return `${layerId}|${objectId ?? crypto.randomUUID()}`; }

    function buildParcelSymbol(hex, opacity) {
      const rgba = new Color(hex); rgba.a = Number(opacity);
      return { type: "simple-fill", color: rgba, outline: { color: [0,0,0,0.35], width: 1 } };
    }

    function restyleAllSelected() {
      const color = $color.value, op = $opacity.value;
      selectionOverlay.graphics.forEach(g => { g.symbol = buildParcelSymbol(color, op); });
    }

    function toggleParcel(graphic, layerId, objectId) {
      const key = featureKey(layerId, objectId);
      if (selectedSet.has(key)) {
        // remove
        const g = selectedSet.get(key);
        selectionOverlay.remove(g);
        selectedSet.delete(key);
      } else {
        // add
        const overlayGraphic = new Graphic({
          geometry: graphic.geometry.clone(),
          symbol: buildParcelSymbol($color.value, $opacity.value),
          attributes: { layerId, objectId }
        });
        selectionOverlay.add(overlayGraphic);
        selectedSet.set(key, overlayGraphic);
      }
      syncSelectedInfo();
    }

    function buildLayerCheckbox(layer) {
      const wrapper = document.createElement("div");
      wrapper.className = "layer-item";
      const left = document.createElement("label");
      left.style.display = "flex"; left.style.alignItems = "center"; left.style.gap = "8px";

      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.checked = layer.visible;
      cb.addEventListener("change", () => { layer.visible = cb.checked; });

      const span = document.createElement("span");
      span.textContent = layer.title || layer.id;

      left.appendChild(cb); left.appendChild(span);
      wrapper.appendChild(left);
      return wrapper;
    }

    async function bootstrap() {
      await webmap.loadAll();
// Find the parcel layer you want to search against
const parcelLayer = webmap.allLayers.find(l => (l.title || "").toLowerCase() === "petaluma parcels_22_0210") 
  || webmap.allLayers.find(l => (l.title || "").toLowerCase() === "sonoma county parcels");

// If your parcels layer is a FeatureLayer, you can add a FeatureLayer search source.
// IMPORTANT: use fields that actually exist in your layer (examples: "SITE_ADDR", "FULLADDR", "APN")
const parcelSource = parcelLayer && parcelLayer.type === "feature"
  ? {
      layer: parcelLayer,
      searchFields: ["SITE_ADDR", "FULLADDR", "APN"],
      displayField: "SITE_ADDR",
      exactMatch: false,
      outFields: ["*"],
      name: parcelLayer.title,
      placeholder: "Address or APN (parcel layer)"
    }
  : null;

const search = new Search({
  view,
  includeDefaultSources: true,        // World geocoder
  popupEnabled: false,
  resultGraphicEnabled: true,
  sources: [
    ...(parcelSource ? [parcelSource] : []),
    // keep the default geocoder too (user can type any address)
  ]
});

// Put it in your existing left panel (cleanest)
document.querySelector(".panel").prepend(search.container);

      // Build visibility list (all layers)
      $layersContainer.innerHTML = "";
      webmap.allLayers.forEach(layer => $layersContainer.appendChild(buildLayerCheckbox(layer)));

      // Initialize UI from first selectable layer's defaults (if present)
      const firstSelectable = webmap.allLayers.find(isSelectableLayer);
      if (firstSelectable?.renderer) {
        try {
          const sym = firstSelectable.renderer.type === "simple"
            ? firstSelectable.renderer.symbol
            : (firstSelectable.renderer.defaultSymbol || firstSelectable.renderer.uniqueValueInfos?.[0]?.symbol || firstSelectable.renderer.classBreakInfos?.[0]?.symbol);

          if (sym?.color) $color.value = new Color(sym.color).toHex();
          const op = firstSelectable.opacity ?? 1;
          $opacity.value = op; $opacityValue.textContent = Number(op).toFixed(2);
        } catch {}
      }

      say("Click parcels to toggle selection. Use color/opacity to style. Export JPG when ready.");
    }

    // Update styles live
    $color.addEventListener("input", () => { restyleAllSelected(); say("Updated color."); });
    $opacity.addEventListener("input", () => {
      const v = $opacity.value; $opacityValue.textContent = Number(v).toFixed(2);
      restyleAllSelected(); say("Updated opacity.");
    });

    $clearSelectionBtn.addEventListener("click", () => {
      selectionOverlay.removeAll();
      selectedSet.clear();
      syncSelectedInfo();
      say("Selection cleared.");
    });

    // Export JPG
   function fmtDate(d = new Date()) {
  const mm = String(d.getMonth() + 1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${mm}/${dd}/${yyyy}`;
}

function getSelectedLabel() {
  // you can improve this by storing address/APN when selecting
  const n = selectionOverlay.graphics.length;
  return n === 1 ? "Selected parcel" : `Selected parcels (${n})`;
}

// simple north arrow (triangle) drawn in footer
function drawNorthArrow(ctx, x, y, size) {
  ctx.save();
  ctx.translate(x, y);
  ctx.beginPath();
  ctx.moveTo(0, -size);
  ctx.lineTo(size * 0.7, size);
  ctx.lineTo(-size * 0.7, size);
  ctx.closePath();
  ctx.fillStyle = "#111";
  ctx.fill();
  ctx.restore();
}

// very simple scalebar: choose a nice round distance near ~1/5 of map width
function niceScaleDistance(meters) {
  const pow10 = Math.pow(10, Math.floor(Math.log10(meters)));
  const n = meters / pow10;
  const nice = n >= 5 ? 5 : n >= 2 ? 2 : 1;
  return nice * pow10;
}

function drawScaleBar(ctx, view, x, y, pxWidth) {
  // approx meters-per-pixel at center latitude
  const lat = view.center?.latitude ?? 0;
  const mPerPx = view.resolution * (Math.cos(lat * Math.PI/180) || 1); // decent approximation for web mercator
  const targetMeters = mPerPx * pxWidth * 0.35;
  const distMeters = niceScaleDistance(targetMeters);
  const barPx = distMeters / mPerPx;

  // draw bar
  ctx.save();
  ctx.strokeStyle = "#111";
  ctx.fillStyle = "#111";
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + barPx, y);
  ctx.stroke();

  // ticks
  ctx.beginPath();
  ctx.moveTo(x, y - 8); ctx.lineTo(x, y + 8);
  ctx.moveTo(x + barPx, y - 8); ctx.lineTo(x + barPx, y + 8);
  ctx.stroke();

  // label
  const label = distMeters >= 1000 ? `${(distMeters/1000).toFixed(distMeters % 1000 === 0 ? 0 : 1)} km` : `${Math.round(distMeters)} m`;
  ctx.font = "12px system-ui, Arial";
  ctx.fillText(label, x, y - 12);
  ctx.restore();
}

async function exportLayoutJpg() {
  const ratio = Number($pixelRatio.value) || 1;

  // 1) get map image
  const shot = await view.takeScreenshot({
    format: "png",
    quality: 1,
    width: Math.floor(view.width * ratio),
    height: Math.floor(view.height * ratio)
  });

  // 2) create layout canvas (map + footer)
  const footerH = Math.floor(110 * ratio);
  const W = shot.data.width;
  const H = shot.data.height + footerH;

  const canvas = document.createElement("canvas");
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext("2d");

  // background
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, W, H);

  // draw map image
  const img = new Image();
  img.src = shot.dataUrl;
  await img.decode();
  ctx.drawImage(img, 0, 0, W, shot.data.height);

  // footer divider line
  ctx.strokeStyle = "#111";
  ctx.lineWidth = Math.max(1, Math.floor(1 * ratio));
  ctx.beginPath();
  ctx.moveTo(0, shot.data.height);
  ctx.lineTo(W, shot.data.height);
  ctx.stroke();

  // footer content
  const pad = Math.floor(14 * ratio);
  const footerTop = shot.data.height;
  const midY = footerTop + Math.floor(footerH / 2);

  // left: date + legend
  ctx.fillStyle = "#111";
  ctx.font = `${Math.floor(12 * ratio)}px system-ui, Arial`;
  ctx.fillText(fmtDate(), pad, footerTop + pad + Math.floor(12 * ratio));

  // legend swatch (use current selection color)
  const sw = Math.floor(26 * ratio);
  const lx = pad;
  const ly = footerTop + Math.floor(footerH * 0.55) - Math.floor(sw/2);

  ctx.strokeStyle = $color.value;
  ctx.lineWidth = Math.max(2, Math.floor(3 * ratio));
  ctx.strokeRect(lx, ly, sw, sw);

  ctx.fillStyle = "#111";
  ctx.font = `${Math.floor(13 * ratio)}px system-ui, Arial`;
  ctx.fillText(getSelectedLabel(), lx + sw + Math.floor(10 * ratio), ly + Math.floor(sw*0.72));

  // center/right: north arrow + scalebar
  const nx = Math.floor(W * 0.62);
  drawNorthArrow(ctx, nx, midY, Math.floor(18 * ratio));
  drawScaleBar(ctx, view, nx + Math.floor(45 * ratio), midY + Math.floor(18 * ratio), W);

  // optional: title bottom-right
  ctx.font = `${Math.floor(11 * ratio)}px system-ui, Arial`;
  ctx.fillStyle = "#444";
  ctx.fillText("City of Petaluma", W - pad - Math.floor(140 * ratio), footerTop + footerH - pad);

  // 3) export canvas as JPG
  const outUrl = canvas.toDataURL("image/jpeg", 0.92);
  const a = document.createElement("a");
  a.href = outUrl;
  a.download = `parcel_map_${Date.now()}.jpg`;
  document.body.appendChild(a); a.click(); a.remove();
}

    // Click-to-toggle selection (topmost parcel hit from the allowed layers)
    view.on("click", async (event) => {
      const hit = await view.hitTest(event);
      if (!hit?.results?.length) { say("No feature here."); return; }

      // Find the first hit that belongs to an allowed parcel layer
      const match = hit.results.find(r => r.graphic?.layer && isSelectableLayer(r.graphic.layer));
      if (!match) { say("Clicked feature isn’t a parcel in the allowed layers.", false); return; }

      const lyr = match.graphic.layer;
      const g = match.graphic;
      const oidField = lyr.objectIdField || "OBJECTID";
      const objectId = g.attributes?.[oidField] ?? null;

      toggleParcel(g, lyr.id, objectId);
      say("Toggled parcel selection.");
    });

    view.when(bootstrap).catch(err => { console.error(err); say("Failed to load WebMap.", false); });
  </script>
</body>
</html>


