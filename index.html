<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Click-to-Select (Layout JPG Export)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/@arcgis/core/assets/esri/themes/light/main.css" />
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; }
    .panel {
      position: absolute; z-index: 5; top: 12px; left: 12px;
      background: rgba(255,255,255,.95); border-radius: 12px; padding: 12px 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12); min-width: 360px; font-family: ui-sans-serif, system-ui, Arial;
      max-height: calc(100% - 24px); overflow: auto;
    }
    .section { margin-bottom: 14px; }
    .section h3 { margin: 0 0 6px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; margin: 8px 0; }
    .row label { font-size: 13px; color: #333; }
    .muted { color: #666; font-size: 12px; }
    select, input, button {
      border: 1px solid #d0d7de; border-radius: 8px; padding: 7px 10px; font-size: 13px;
    }
    input[type="range"] { width: 170px; }
    .layer-list { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; background: #fafafa; }
    .layer-item { display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-radius:6px; }
    .layer-item:hover { background:#f0f3f6; }
    #status { font-size: 12px; color: #0b5; min-height: 1em; margin-top: 6px; }
    .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
    .search-holder { margin: 10px 0 12px; }
  </style>
</head>

<body>
  <div id="viewDiv" title="Click parcels to toggle selection"></div>

  <div class="panel">
    <div class="section">
      <h3><strong>Parcel Styling (Click to select)</strong></h3>
      <div class="muted">Click parcels to toggle them on/off. Only “Sonoma County Parcels” and “Petaluma Parcels_22_0210” are selectable.</div>
      <div id="searchHolder" class="search-holder"></div>
    </div>

    <div class="section">
      <h3>Layers (visibility)</h3>
      <div id="layersContainer" class="layer-list"></div>
    </div>

    <div class="section">
      <h3>Style selected parcel(s)</h3>
      <div class="row">
        <label for="colorPicker">Color</label>
        <input id="colorPicker" type="color" value="#ff5500" />
      </div>
      <div class="row">
        <label for="opacitySlider">Opacity <span id="opacityValue" class="muted">1.00</span></label>
        <input id="opacitySlider" type="range" min="0" max="1" step="0.01" value="1" />
      </div>
      <div class="btn-row">
        <button id="clearSelectionBtn">Clear selection</button>
      </div>
      <div class="muted" id="selectedInfo">No parcels selected.</div>
    </div>

    <div class="section">
      <h3>Export (Layout JPG)</h3>
      <div class="row">
        <label for="mapTitle">Title</label>
        <input id="mapTitle" type="text" maxlength="70" placeholder="e.g., 307 Kent St" />
      </div>
      <div class="muted" style="margin-top:-4px;">Max 70 characters.</div>

      <div class="row" style="margin-top:10px;">
        <label for="pixelRatio">Pixel ratio <span id="pxrVal" class="muted">1.0</span></label>
        <input id="pixelRatio" type="range" min="1" max="3" step="0.1" value="1" />
      </div>
      <div class="btn-row">
        <button id="exportJpgBtn">Export JPG</button>
      </div>
      <div class="muted">Higher pixel ratio = higher resolution image.</div>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import WebMap from "https://js.arcgis.com/4.29/@arcgis/core/WebMap.js";
    import MapView from "https://js.arcgis.com/4.29/@arcgis/core/views/MapView.js";
    import Color from "https://js.arcgis.com/4.29/@arcgis/core/Color.js";
    import GraphicsLayer from "https://js.arcgis.com/4.29/@arcgis/core/layers/GraphicsLayer.js";
    import Graphic from "https://js.arcgis.com/4.29/@arcgis/core/Graphic.js";
    import Search from "https://js.arcgis.com/4.29/@arcgis/core/widgets/Search.js";

    // --- REQUIRED: your WebMap ID ---
    const WEBMAP_ID = "d2e42cb6b87c4126b2e609a362d82c1c";

    // ✅ Only these layers are selectable
    const SELECTABLE_LAYER_TITLES = [
      "Sonoma County Parcels",
      "Petaluma Parcels_22_0210"
    ];
    const selectableTitlesLower = SELECTABLE_LAYER_TITLES.map(t => t.toLowerCase());

    // Elements
    const $layersContainer = document.getElementById("layersContainer");
    const $color = document.getElementById("colorPicker");
    const $opacity = document.getElementById("opacitySlider");
    const $opacityValue = document.getElementById("opacityValue");
    const $clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const $exportJpgBtn = document.getElementById("exportJpgBtn");
    const $pixelRatio = document.getElementById("pixelRatio");
    const $pxrVal = document.getElementById("pxrVal");
    const $selectedInfo = document.getElementById("selectedInfo");
    const $status = document.getElementById("status");
    const $searchHolder = document.getElementById("searchHolder");
    const $mapTitle = document.getElementById("mapTitle");

    const webmap = new WebMap({ portalItem: { id: WEBMAP_ID } });
    const view = new MapView({ container: "viewDiv", map: webmap });

    // Graphics layer to draw selected parcels (non-destructive)
    const selectionOverlay = new GraphicsLayer({ title: "Selection Overlay", listMode: "hide" });
    webmap.add(selectionOverlay);

    // State
    const selectedSet = new Map(); // key -> Graphic

    function say(msg, ok = true) {
      $status.style.color = ok ? "#0b5" : "#a00";
      $status.textContent = msg;
    }

    function isSelectableLayer(layer) {
      const title = (layer.title || "").trim().toLowerCase();
      return selectableTitlesLower.includes(title);
    }

    function syncSelectedInfo() {
      const count = selectionOverlay.graphics.length;
      $selectedInfo.textContent = count ? `Selected parcels: ${count}` : "No parcels selected.";
    }

    function featureKey(layerId, objectId) {
      return `${layerId}|${objectId ?? crypto.randomUUID()}`;
    }

    function buildParcelSymbol(hex, opacity) {
      const rgba = new Color(hex); rgba.a = Number(opacity);
      return { type: "simple-fill", color: rgba, outline: { color: [0,0,0,0.35], width: 1 } };
    }

    function restyleAllSelected() {
      const color = $color.value, op = $opacity.value;
      selectionOverlay.graphics.forEach(g => { g.symbol = buildParcelSymbol(color, op); });
    }

    function toggleParcel(graphic, layerId, objectId) {
      const key = featureKey(layerId, objectId);
      if (selectedSet.has(key)) {
        const g = selectedSet.get(key);
        selectionOverlay.remove(g);
        selectedSet.delete(key);
      } else {
        const overlayGraphic = new Graphic({
          geometry: graphic.geometry.clone(),
          symbol: buildParcelSymbol($color.value, $opacity.value),
          attributes: { layerId, objectId }
        });
        selectionOverlay.add(overlayGraphic);
        selectedSet.set(key, overlayGraphic);
      }
      syncSelectedInfo();
    }

    function buildLayerCheckbox(layer) {
      const wrapper = document.createElement("div");
      wrapper.className = "layer-item";
      const left = document.createElement("label");
      left.style.display = "flex"; left.style.alignItems = "center"; left.style.gap = "8px";

      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.checked = layer.visible;
      cb.addEventListener("change", () => { layer.visible = cb.checked; });

      const span = document.createElement("span");
      span.textContent = layer.title || layer.id;

      left.appendChild(cb); left.appendChild(span);
      wrapper.appendChild(left);
      return wrapper;
    }

    function getTitleText() {
      const raw = ($mapTitle?.value || "").trim();
      const capped = raw.slice(0, 70);
      return capped.replace(/\s+/g, " ");
    }

    // ------------------------------
    // Layout helpers (export)
    // ------------------------------
    function formatScale(s) {
      return `1:${Math.round(s).toLocaleString()}`;
    }

    function niceScaleDistance(meters) {
      const pow10 = Math.pow(10, Math.floor(Math.log10(meters)));
      const n = meters / pow10;
      const nice = n >= 5 ? 5 : n >= 2 ? 2 : 1;
      return nice * pow10;
    }

    function drawNorthArrow(ctx, x, y, size, ratio) {
      ctx.save();
      ctx.translate(x, y);

      // arrow
      ctx.beginPath();
      ctx.moveTo(0, -size);
      ctx.lineTo(size * 0.70, size);
      ctx.lineTo(0, size * 0.55);
      ctx.lineTo(-size * 0.70, size);
      ctx.closePath();
      ctx.fillStyle = "#111";
      ctx.fill();

      // N label
      ctx.fillStyle = "#111";
      ctx.font = `700 ${Math.floor(16 * ratio)}px system-ui, Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText("N", 0, size + Math.floor(10 * ratio));

      ctx.restore();
    }

    function drawScaleBarDetailed(ctx, view, x, y, totalPx, ratio) {
      const lat = view.center?.latitude ?? 0;
      const mPerPx = view.resolution * (Math.cos(lat * Math.PI/180) || 1);

      // total bar distance (meters)
      const targetMeters = mPerPx * totalPx;
      const totalMeters = niceScaleDistance(targetMeters);

      const segments = 4;
      const segMeters = totalMeters / segments;
      const segPx = (segMeters / mPerPx);

      const barH = Math.floor(10 * ratio);
      const tickH = Math.floor(10 * ratio);
      const labelGap = Math.floor(6 * ratio);

      ctx.save();
      ctx.lineWidth = Math.max(2, Math.floor(2 * ratio));
      ctx.strokeStyle = "#111";

      // alternating segments
      for (let i = 0; i < segments; i++) {
        const sx = x + i * segPx;
        ctx.beginPath();
        ctx.rect(sx, y, segPx, barH);
        ctx.fillStyle = (i % 2 === 0) ? "#111" : "#fff";
        ctx.fill();
        ctx.stroke();
      }

      // ticks + labels
      ctx.fillStyle = "#111";
      ctx.font = `${Math.floor(12 * ratio)}px system-ui, Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";

      for (let i = 0; i <= segments; i++) {
        const tx = x + i * segPx;
        ctx.beginPath();
        ctx.moveTo(tx, y);
        ctx.lineTo(tx, y - tickH);
        ctx.stroke();

        const meters = segMeters * i;
        const label = meters >= 1000
          ? `${(meters/1000).toFixed(meters % 1000 === 0 ? 0 : 1)}`
          : `${Math.round(meters)}`;
        ctx.fillText(label, tx, y - tickH - labelGap);
      }

      // units + scale ratio
      const units = totalMeters >= 1000 ? "km" : "m";
      ctx.textAlign = "left";
      ctx.textBaseline = "alphabetic";
      ctx.font = `${Math.floor(12 * ratio)}px system-ui, Arial`;
      ctx.fillText(units, x + totalPx + Math.floor(10 * ratio), y + barH);

      ctx.textAlign = "right";
      ctx.font = `600 ${Math.floor(12 * ratio)}px system-ui, Arial`;
      ctx.fillText(formatScale(view.scale), x + totalPx, y + barH + Math.floor(28 * ratio));

      ctx.restore();
    }

    async function exportLayoutJpg() {
      const ratio = Number($pixelRatio.value) || 1;

      // Grab map screenshot
      const shot = await view.takeScreenshot({
        format: "png",
        quality: 1,
        width: Math.floor(view.width * ratio),
        height: Math.floor(view.height * ratio)
      });

      const img = new Image();
      img.src = shot.dataUrl;
      await img.decode();

      // Layout sizing
      const margin = Math.floor(24 * ratio);
      const framePad = Math.floor(10 * ratio);
      const headerH = Math.floor(62 * ratio);
      const footerH = Math.floor(160 * ratio);

      const mapW = shot.data.width;
      const mapH = shot.data.height;

      const contentW = mapW + framePad * 2;
      const contentH = headerH + mapH + footerH + framePad * 2;

      const canvas = document.createElement("canvas");
      canvas.width = contentW + margin * 2;
      canvas.height = contentH + margin * 2;
      const ctx = canvas.getContext("2d");

      // Background
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const x0 = margin;
      const y0 = margin;

      // Outer border
      ctx.strokeStyle = "#111";
      ctx.lineWidth = Math.max(2, Math.floor(2 * ratio));
      ctx.strokeRect(x0, y0, contentW, contentH);

      // Map frame rect
      const mapX = x0 + framePad;
      const mapY = y0 + headerH + framePad;
      const footerTop = mapY + mapH + framePad;

      // Header band
      ctx.fillStyle = "#fff";
      ctx.fillRect(x0 + 1, y0 + 1, contentW - 2, headerH - 1);

      // Footer band
      ctx.fillStyle = "#fff";
      ctx.fillRect(x0 + 1, footerTop, contentW - 2, footerH);

      // Title
      const title = getTitleText() || "Project Site Map";
      ctx.fillStyle = "#111";
      ctx.font = `700 ${Math.floor(18 * ratio)}px system-ui, Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(title, x0 + contentW / 2, y0 + headerH / 2);

      // Map frame + image
      ctx.textAlign = "left";
      ctx.textBaseline = "alphabetic";
      ctx.strokeStyle = "#111";
      ctx.lineWidth = Math.max(1, Math.floor(1 * ratio));
      ctx.strokeRect(mapX, mapY, mapW, mapH);
      ctx.drawImage(img, mapX, mapY, mapW, mapH);

      // Footer divider line (between map and footer)
      ctx.strokeStyle = "#111";
      ctx.lineWidth = Math.max(1, Math.floor(1 * ratio));
      ctx.beginPath();
      ctx.moveTo(x0, footerTop);
      ctx.lineTo(x0 + contentW, footerTop);
      ctx.stroke();

      // Footer content layout
      const pad = Math.floor(14 * ratio);

      // Legend (bigger)
      const sw = Math.floor(34 * ratio);
      const legendX = x0 + pad;
      const legendY = footerTop + pad;

      ctx.strokeStyle = $color.value;
      ctx.lineWidth = Math.max(3, Math.floor(3 * ratio));
      ctx.strokeRect(legendX, legendY, sw, sw);

      ctx.fillStyle = "#111";
      ctx.font = `${Math.floor(16 * ratio)}px system-ui, Arial`;
      const legendLabel = selectionOverlay.graphics.length === 1 ? "Selected parcel" : `Selected parcels (${selectionOverlay.graphics.length})`;
      ctx.fillText(legendLabel, legendX + sw + Math.floor(12 * ratio), legendY + Math.floor(sw * 0.75));

      // Attribution / disclaimer (professional)
      ctx.fillStyle = "#444";
      ctx.font = `${Math.floor(10.5 * ratio)}px system-ui, Arial`;
      const lines = [
        "Sources: Esri; Permit Sonoma; City of Petaluma; and other contributing data providers.",
        "Map prepared via a third-party web mapping application accessed by a City contractor.",
        "This map is for general reference only to illustrate the project site in connection with required public notice materials."
      ];
      let ty = legendY + sw + Math.floor(18 * ratio);
      for (const line of lines) {
        ctx.fillText(line, legendX, ty);
        ty += Math.floor(14 * ratio);
      }

      // North arrow + scalebar on right
      const rightX = x0 + contentW - pad;
      const arrowX = rightX - Math.floor(90 * ratio);
      const arrowY = footerTop + pad + Math.floor(24 * ratio);
      drawNorthArrow(ctx, arrowX, arrowY, Math.floor(22 * ratio), ratio);

      const scaleBarWidth = Math.floor(240 * ratio);
      const scaleX = rightX - scaleBarWidth;
      const scaleY = footerTop + pad + Math.floor(34 * ratio);
      drawScaleBarDetailed(ctx, view, scaleX, scaleY, scaleBarWidth, ratio);

      // Export
      const outUrl = canvas.toDataURL("image/jpeg", 0.92);
      const a = document.createElement("a");
      a.href = outUrl;
      a.download = `parcel_map_${Date.now()}.jpg`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    // ------------------------------
    // Bootstrap
    // ------------------------------
    async function bootstrap() {
      await webmap.loadAll();

      // Search widget (reliable container)
      const parcelLayer =
        webmap.allLayers.find(l => (l.title || "").toLowerCase() === "petaluma parcels_22_0210") ||
        webmap.allLayers.find(l => (l.title || "").toLowerCase() === "sonoma county parcels");

      const parcelSource = (parcelLayer && parcelLayer.type === "feature") ? {
        layer: parcelLayer,
        searchFields: ["SITE_ADDR", "FULLADDR", "APN"],
        displayField: "SITE_ADDR",
        exactMatch: false,
        outFields: ["*"],
        name: parcelLayer.title,
        placeholder: "Address or APN (parcel layer)"
      } : null;

      const search = new Search({
        view,
        includeDefaultSources: true,
        popupEnabled: false,
        resultGraphicEnabled: true,
        sources: [
          ...(parcelSource ? [parcelSource] : [])
        ]
      });

      // IMPORTANT: set container explicitly
      search.container = $searchHolder;

      // Layer visibility list
      $layersContainer.innerHTML = "";
      webmap.allLayers.forEach(layer => $layersContainer.appendChild(buildLayerCheckbox(layer)));

      // Initialize style defaults from first selectable
      const firstSelectable = webmap.allLayers.find(isSelectableLayer);
      if (firstSelectable?.renderer) {
        try {
          const sym = firstSelectable.renderer.type === "simple"
            ? firstSelectable.renderer.symbol
            : (firstSelectable.renderer.defaultSymbol || firstSelectable.renderer.uniqueValueInfos?.[0]?.symbol || firstSelectable.renderer.classBreakInfos?.[0]?.symbol);

          if (sym?.color) $color.value = new Color(sym.color).toHex();
          const op = firstSelectable.opacity ?? 1;
          $opacity.value = op; $opacityValue.textContent = Number(op).toFixed(2);
        } catch {}
      }

      say("Click parcels to toggle selection. Use Export JPG for the layout map.");
    }

    // ------------------------------
    // UI bindings
    // ------------------------------
    $color.addEventListener("input", () => { restyleAllSelected(); say("Updated color."); });
    $opacity.addEventListener("input", () => {
      const v = $opacity.value; $opacityValue.textContent = Number(v).toFixed(2);
      restyleAllSelected(); say("Updated opacity.");
    });

    $clearSelectionBtn.addEventListener("click", () => {
      selectionOverlay.removeAll();
      selectedSet.clear();
      syncSelectedInfo();
      say("Selection cleared.");
    });

    $pixelRatio.addEventListener("input", () => {
      $pxrVal.textContent = Number($pixelRatio.value).toFixed(1);
    });

    $exportJpgBtn.addEventListener("click", async () => {
      try {
        await exportLayoutJpg();
        say("Layout JPG exported.");
      } catch (e) {
        console.error(e);
        say("Export failed.", false);
      }
    });

    // Click-to-toggle selection (topmost parcel hit from the allowed layers)
    view.on("click", async (event) => {
      const hit = await view.hitTest(event);
      if (!hit?.results?.length) { say("No feature here."); return; }

      const match = hit.results.find(r => r.graphic?.layer && isSelectableLayer(r.graphic.layer));
      if (!match) { say("Clicked feature isn’t a parcel in the allowed layers.", false); return; }

      const lyr = match.graphic.layer;
      const g = match.graphic;
      const oidField = lyr.objectIdField || "OBJECTID";
      const objectId = g.attributes?.[oidField] ?? null;

      toggleParcel(g, lyr.id, objectId);
      say("Toggled parcel selection.");
    });

    view.when(bootstrap).catch(err => { console.error(err); say("Failed to load WebMap.", false); });
  </script>
</body>
</html>
