<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parcel Click-to-Select (Layout JPG Export)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/@arcgis/core/assets/esri/themes/light/main.css" />
  <style>
    html, body, #viewDiv { height: 100%; margin: 0; }
    .panel{
      position:absolute; z-index:5; top:12px; left:12px;
      background:rgba(255,255,255,.95); border-radius:12px; padding:12px 14px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
      min-width:360px; font-family:ui-sans-serif,system-ui,Arial;
      max-height:calc(100% - 24px); overflow:auto;
    }
    .section{ margin-bottom:14px; }
    .section h3{ margin:0 0 6px; font-size:14px; }
    .row{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; margin:8px 0; }
    .row label{ font-size:13px; color:#333; }
    .muted{ color:#666; font-size:12px; }
    select,input,button{ border:1px solid #d0d7de; border-radius:8px; padding:7px 10px; font-size:13px; }
    input[type="range"]{ width:170px; }
    .layer-list{ border:1px solid #e5e7eb; border-radius:10px; padding:8px; background:#fafafa; }
    .layer-item{ display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-radius:6px; }
    .layer-item:hover{ background:#f0f3f6; }
    #status{ font-size:12px; color:#0b5; min-height:1em; margin-top:6px; white-space:pre-wrap; }
    .btn-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .search-holder{ margin:10px 0 12px; }
  </style>
</head>

<body>
  <div id="viewDiv"></div>

  <div class="panel">
    <div class="section">
      <h3><strong>Parcel Styling (Click to select)</strong></h3>
      <div class="muted">Click parcels to toggle them on/off. Only “Sonoma County Parcels” and “Petaluma Parcels_22_0210” are selectable.</div>
      <div id="searchHolder" class="search-holder"></div>
    </div>

    <div class="section">
      <h3>Layers (visibility)</h3>
      <div id="layersContainer" class="layer-list"></div>
    </div>

    <div class="section">
      <h3>Style selected parcel(s)</h3>
      <div class="row">
        <label for="colorPicker">Color</label>
        <input id="colorPicker" type="color" value="#ff5500" />
      </div>
      <div class="row">
        <label for="opacitySlider">Opacity <span id="opacityValue" class="muted">1.00</span></label>
        <input id="opacitySlider" type="range" min="0" max="1" step="0.01" value="1" />
      </div>
      <div class="btn-row">
        <button id="clearSelectionBtn">Clear selection</button>
      </div>
      <div class="muted" id="selectedInfo">No parcels selected.</div>
    </div>

    <div class="section">
      <h3>Export (Layout JPG)</h3>
      <div class="row">
        <label for="mapTitle">Title</label>
        <input id="mapTitle" type="text" maxlength="70" placeholder="e.g., 307 Kent St" />
      </div>
      <div class="muted" style="margin-top:-4px;">Max 70 characters.</div>

      <div class="row" style="margin-top:10px;">
        <label for="pixelRatio">Pixel ratio <span id="pxrVal" class="muted">1.0</span></label>
        <input id="pixelRatio" type="range" min="1" max="3" step="0.1" value="1" />
      </div>

      <div class="btn-row">
        <button id="exportJpgBtn">Export JPG</button>
      </div>
      <div class="muted">Higher pixel ratio = higher resolution image.</div>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import WebMap from "https://js.arcgis.com/4.29/@arcgis/core/WebMap.js";
    import MapView from "https://js.arcgis.com/4.29/@arcgis/core/views/MapView.js";
    import Color from "https://js.arcgis.com/4.29/@arcgis/core/Color.js";
    import GraphicsLayer from "https://js.arcgis.com/4.29/@arcgis/core/layers/GraphicsLayer.js";
    import Graphic from "https://js.arcgis.com/4.29/@arcgis/core/Graphic.js";
    import Search from "https://js.arcgis.com/4.29/@arcgis/core/widgets/Search.js";

    const WEBMAP_ID = "0915d8a57b6c4948b4dc91646f714775";

    const SELECTABLE_LAYER_TITLES = ["Sonoma County Parcels", "Petaluma Parcels_22_0210"];
    const selectableTitlesLower = SELECTABLE_LAYER_TITLES.map(t => t.toLowerCase());

    const $layersContainer = document.getElementById("layersContainer");
    const $color = document.getElementById("colorPicker");
    const $opacity = document.getElementById("opacitySlider");
    const $opacityValue = document.getElementById("opacityValue");
    const $clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const $exportJpgBtn = document.getElementById("exportJpgBtn");
    const $pixelRatio = document.getElementById("pixelRatio");
    const $pxrVal = document.getElementById("pxrVal");
    const $selectedInfo = document.getElementById("selectedInfo");
    const $status = document.getElementById("status");
    const $searchHolder = document.getElementById("searchHolder");
    const $mapTitle = document.getElementById("mapTitle");

    const webmap = new WebMap({ portalItem: { id: WEBMAP_ID } });
    const view = new MapView({ container: "viewDiv", map: webmap });

    const selectionOverlay = new GraphicsLayer({ title: "Selection Overlay", listMode: "hide" });
    webmap.add(selectionOverlay);

    const selectedSet = new Map();

    function say(msg, ok = true) {
      $status.style.color = ok ? "#0b5" : "#a00";
      $status.textContent = msg;
    }

    function isSelectableLayer(layer) {
      const title = (layer?.title || "").trim().toLowerCase();
      return selectableTitlesLower.includes(title);
    }

    function syncSelectedInfo() {
      const count = selectionOverlay.graphics.length;
      $selectedInfo.textContent = count ? `Selected parcels: ${count}` : "No parcels selected.";
    }

    function featureKey(layerId, objectId) {
      return `${layerId}|${objectId ?? crypto.randomUUID()}`;
    }

    function buildParcelSymbol(hex, opacity) {
      const rgba = new Color(hex);
      rgba.a = Number(opacity);
      return { type: "simple-fill", color: rgba, outline: { color: [0,0,0,0.35], width: 1 } };
    }

    function restyleAllSelected() {
      const color = $color.value, op = $opacity.value;
      selectionOverlay.graphics.forEach(g => { g.symbol = buildParcelSymbol(color, op); });
    }

    function getParcelLabel(g) {
      const a = g?.attributes || {};
      const candidates = ["SITE_ADDR","FULLADDR","ADDRESS","ADDR","SITUSADDR","SITUS","APN","APN_NUM","PARCELAPN"];
      for (const k of candidates) {
        const v = a[k];
        if (v !== undefined && v !== null && String(v).trim()) return String(v).trim();
      }
      return "Project Site";
    }

    function toggleParcel(graphic, layerId, objectId) {
      const key = featureKey(layerId, objectId);
      if (selectedSet.has(key)) {
        const g = selectedSet.get(key);
        selectionOverlay.remove(g);
        selectedSet.delete(key);
      } else {
        const overlayGraphic = new Graphic({
          geometry: graphic.geometry.clone(),
          symbol: buildParcelSymbol($color.value, $opacity.value),
          attributes: { layerId, objectId, label: getParcelLabel(graphic) }
        });
        selectionOverlay.add(overlayGraphic);
        selectedSet.set(key, overlayGraphic);
      }
      syncSelectedInfo();
    }

    function buildLayerCheckbox(layer) {
      const wrapper = document.createElement("div");
      wrapper.className = "layer-item";

      const left = document.createElement("label");
      left.style.display = "flex";
      left.style.alignItems = "center";
      left.style.gap = "8px";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = layer.visible;
      cb.addEventListener("change", () => { layer.visible = cb.checked; });

      const span = document.createElement("span");
      span.textContent = layer.title || layer.id;

      left.appendChild(cb);
      left.appendChild(span);
      wrapper.appendChild(left);
      return wrapper;
    }

    function getTitleText() {
      const raw = ($mapTitle?.value || "").trim();
      return raw.slice(0, 70).replace(/\s+/g, " ") || "Project Site Map";
    }

    // (Your exportLayoutJpg() + helpers stay exactly as you already had them)
    // ---------------------------------------------------------------
    // NOTE: Keep your existing exportLayoutJpg() block below unchanged
    // ---------------------------------------------------------------

    async function bootstrap() {
      await webmap.load();
      await webmap.loadAll();

      // ---- Search: ALWAYS render ----
      const all = webmap.allLayers.toArray();
      const parcelLayer =
        all.find(l => l.type === "feature" && isSelectableLayer(l)) ||
        all.find(l => l.type === "feature" && (l.title || "").toLowerCase().includes("parcel"));

      const parcelSource = parcelLayer ? {
        layer: parcelLayer,
        searchFields: ["SITE_ADDR", "FULLADDR", "APN"],
        displayField: "SITE_ADDR",
        exactMatch: false,
        outFields: ["*"],
        name: parcelLayer.title,
        placeholder: "Address or APN (parcel layer)"
      } : null;

      const searchOpts = {
        view,
        container: $searchHolder,
        includeDefaultSources: true,
        popupEnabled: false,
        resultGraphicEnabled: true
      };
      if (parcelSource) searchOpts.sources = [parcelSource];
      new Search(searchOpts);

      // ---- Layer list: use toArray() ----
      $layersContainer.innerHTML = "";
      webmap.allLayers.toArray().forEach(layer => {
        $layersContainer.appendChild(buildLayerCheckbox(layer));
      });

      say("Loaded. Click parcels to toggle selection.");
    }

    $color.addEventListener("input", () => { restyleAllSelected(); say("Updated color."); });
    $opacity.addEventListener("input", () => {
      const v = $opacity.value;
      $opacityValue.textContent = Number(v).toFixed(2);
      restyleAllSelected();
      say("Updated opacity.");
    });

    $clearSelectionBtn.addEventListener("click", () => {
      selectionOverlay.removeAll();
      selectedSet.clear();
      syncSelectedInfo();
      say("Selection cleared.");
    });

    $pixelRatio.addEventListener("input", () => {
      $pxrVal.textContent = Number($pixelRatio.value).toFixed(1);
    });

    // NOTE: wire your export button to your existing exportLayoutJpg()
    // $exportJpgBtn.addEventListener("click", async () => { await exportLayoutJpg(); });

    view.on("click", async (event) => {
      const hit = await view.hitTest(event);
      if (!hit?.results?.length) { say("No feature here."); return; }

      const match = hit.results.find(r => r.graphic?.layer && isSelectableLayer(r.graphic.layer));
      if (!match) { say("Clicked feature isn’t a parcel in the allowed layers.", false); return; }

      const lyr = match.graphic.layer;
      const g = match.graphic;
      const oidField = lyr.objectIdField || "OBJECTID";
      const objectId = g.attributes?.[oidField] ?? null;

      toggleParcel(g, lyr.id, objectId);
      say("Toggled parcel selection.");
    });

    view.when(bootstrap).catch(err => {
      console.error("BOOTSTRAP/WEBMAP ERROR:", err);
      say(err?.message || "Failed to load WebMap.", false);
    });
  </script>
</body>
</html>
